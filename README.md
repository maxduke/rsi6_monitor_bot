# A股/ETF RSI 监控 Telegram 机器人

这是一个功能丰富的 Telegram 机器人，用于实时监控中国A股或场内基金的 RSI 指标。当指定的股票或ETF的RSI值进入您设定的目标区间时，它会立即发送通知。

## ✨ 功能特性

- **多规则监控**: 支持为同一个资产设置多个不同的RSI监控区间。
- **即时查询**: 用户可随时使用 `/check` 命令，获取所有监控资产的最新RSI值。
- **每日简报**: 可选功能，在每个交易日收盘后，向开启了此功能的用户推送一份定制化的RSI简报。
- **白名单**: 只有授权的 Telegram 用户才能与机器人交互。
- **开盘监控**: 任务仅在中国 A 股交易日及交易时段内运行，自动处理节假日和调休。
- **高效缓存**: 资产名称和历史数据均有缓存机制，最大限度减少API调用。
- **健壮性设计**: 包含随机延迟、请求间隔、失败重试与管理员警报等多种机制。
- **RSI 计算更稳健**: 计算时保留完整历史数据，剔除当日不完整日线，并使用实时价覆盖当日数据以避免重复。
- **Docker化**: 提供优化的 `Dockerfile` 和 `docker-compose.yml`，实现一键启动。
- **CI/CD**: 集成 GitHub Actions，自动构建并推送多架构镜像到 Docker Hub 和 GHCR。
- **ETF 数据源优化**: 历史净值来自新浪净值接口，实时净值使用东方财富开放式基金日度快照（一次拉取全量，列名随日期变化）。

## 🤖 机器人命令

- `/start` - 开始使用机器人。
- `/help` - 获取帮助信息。
- `/check` - 立即查询您所有激活规则的当前RSI值。
- `/briefing on|off` - 开启或关闭您的每日收盘简报。
- `/add <code> <min> <max>` - 添加一条监控规则。
- `/del <id>` - 删除一条规则。
- `/list` - 查看您的所有监控规则。
- `/on <id>` - 开启一条规则。
- `/off <id>` - 关闭一条规则。

### (管理员命令)

- `/add_w <user_id>` - 添加用户到白名单。
- `/del_w <user_id>` - 从白名单移除用户。
- `/list_w` - 查看白名单列表（会显示简报开启状态）。

## ⚙️ 配置

通过在项目根目录创建 `.env` 文件来配置机器人。

### 基础配置

| 环境变量         | 描述                               | 示例值                                     |
| ---------------- | ---------------------------------- | ------------------------------------------ |
| `TELEGRAM_TOKEN` | **必需**. Telegram Bot Token.      | `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11` |
| `ADMIN_USER_ID`  | **必需**. 你的 Telegram User ID.   | `123456789`                                |

### 监控参数配置

| 环境变量                      | 描述                               | 默认值 |
| ----------------------------- | ---------------------------------- | ------ |
| `CHECK_INTERVAL_SECONDS`      | 检查规则的间隔时间（秒）.          | `60`   |
| `RSI_PERIOD`                  | 计算RSI指标的周期.                 | `6`    |
| `RSI_MODE`                    | RSI计算模式 (`sma`=国内常用, `wilder`=国际标准). | `sma`  |
| `USE_ADJUST`                  | 是否使用前复权价格 (`true`=是, `false`=否). | `true` |
| `HIST_FETCH_DAYS`             | 缓存历史数据的保留天数 (非截断长度). | `200`  |
| `MAX_NOTIFICATIONS_PER_TRIGGER` | 单次触发区间内，发送通知的最大次数.| `1`    |

### 高级配置

| 环境变量                   | 描述                                                         | 默认值     |
| -------------------------- | ------------------------------------------------------------ | ---------- |
| `RANDOM_DELAY_MAX_SECONDS` | 在每次检查周期开始时，增加一个0到该秒数之间的随机延迟。     | `0`        |
| `REQUEST_INTERVAL_SECONDS` | 每个API请求之间的固定间隔时间（秒），用于防止接口限制（实时轮询最小 0.3 秒）。     | `1.0`      |
| `FETCH_FAILURE_THRESHOLD`  | 连续获取数据失败多少次后，向管理员发送一条警报通知。         | `5`        |
| `ENABLE_DAILY_BRIEFING`    | **每日简报的主开关**。设为 `true` 以允许用户使用此功能。     | `false`    |
| `DAILY_BRIEFING_TIMES`      | 每日简报的发送时间 (上海时间, 24小时制)。支持多个，用逗号分隔。     | `15:30`    |
| `FETCH_RETRY_ATTEMPTS` | 获取数据失败后的重试次数。     | `3`      |
| `FETCH_RETRY_DELAY_SECONDS`  | 每次重试之间的等待时间（秒）。         | `5`        |

## 📊 数据源说明

- **股票日线历史**: `ak.stock_zh_a_daily`（支持前复权）。
- **ETF 历史净值**: 新浪 `netWorthTable` 接口，复权时使用累计净值字段。
- **ETF 实时净值**: 东方财富 `fund_open_fund_daily_em`，每次调用返回全量基金快照，净值列名随日期变化，程序会自动取最新一列。

## 🚀 部署与运行

**重要提示**: 如果您是从旧版本升级，请务必在部署前**删除旧的数据库文件** (`./data/rules.db`)，因为数据库结构已为支持“每日简报”功能而更新。

1.  **安装 Docker 和 Docker Compose**。
2.  **克隆本仓库**。
3.  **创建并配置 `.env` 文件**。
4.  **启动机器人**:
    ```bash
    docker-compose up -d --build
    ```
5.  **查看日志**: `docker-compose logs -f`
6.  **停止服务**: `docker-compose down`
