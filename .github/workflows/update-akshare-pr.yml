name: Update Akshare via PR

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'   # 每周一 UTC 0 点

permissions:
  contents: write
  pull-requests: write

jobs:
  update-deps-pr:
    runs-on: ubuntu-22.04   # 不用 ubuntu-latest，避免未来漂移

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------
      # Python 固定
      # ----------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      # ----------------------------
      # Toolchain 锁版本（关键）
      # ----------------------------
      - name: Install build tooling
        run: |
          python -m pip install --upgrade \
            pip==25.2 \
            setuptools==75.1.0 \
            wheel==0.44.0

          pip install pip-tools==7.5.2

      # ----------------------------
      # Debug（建议保留）
      # ----------------------------
      - name: Show tool versions
        run: |
          python -V
          pip -V
          pip-compile --version

      # ----------------------------
      # Compile requirements
      # ----------------------------
      - name: Compile requirements
        run: |
          pip-compile \
            --upgrade-package akshare \
            requirements.in \
            -o requirements.txt

      # ----------------------------
      # 检测是否真的有变化
      # ----------------------------
      - name: Detect changes
        id: diff
        run: |
          if git diff --quiet requirements.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # ----------------------------
      # 只在有变化时创建 PR
      # ----------------------------
      - name: Create Pull Request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: upgrade akshare dependency"
          title: "chore: upgrade akshare"
          body: |
            Auto upgrade akshare via CI.
          branch: auto-update/akshare
          base: main
          delete-branch: true
